# Data Access Layer (`app/db`)

This directory contains the data access layer for the Network Simulation Server. It provides all database-related operations, abstracting MongoDB interactions and ensuring a clean separation between business logic and persistence.

## Purpose

- Encapsulates all CRUD operations for events, topologies, and simulations.
- Manages database connections, sessions, and transactions.
- Implements error handling and logging for all database operations.
- Provides pagination, indexing, and concurrency control for scalable and reliable data access.

---

## Database Modules

### `events_db.py` — Events Repository

- Handles CRUD operations for simulation event documents.
- Supports batch insertions, updates, and filtered queries.
- Adds meta fields (created_at, updated_at) and manages event state (published, handled).
- Integrates with business logic for event-driven workflows and transactional updates.

---

### `topologies_simulations_db.py` — Simulations Repository

- Manages CRUD operations for simulation metadata and state.
- Supports creation, retrieval, update (with optimistic concurrency), and pagination of simulations.
- Provides filtered queries by status, topology, and IDs.
- Ensures atomicity for multi-step updates and supports MongoDB transactions.
- Used extensively by business logic for simulation lifecycle management.

---

### `topologies_db.py` — Topologies Repository

- Handles CRUD operations for network topologies.
- Ensures uniqueness using fingerprints for topology structure and configuration.
- Supports bulk updates and cursor-based pagination.
- Used by business logic to validate, store, and retrieve topologies for simulation.

---

### `mongo_db_client.py` — MongoDB Connection Manager

- Manages the lifecycle of the MongoDB connection using Motor (async).
- Handles connection setup, teardown, and health checks.
- Ensures required indexes are created for all collections.
- Provides a single entry point for database access throughout the application.

---

### `__pycache__/` — Python Bytecode Cache

- Contains Python bytecode files generated by the interpreter.
- Can be ignored and should not be version-controlled.

---

## Key Features

- **Atomic Transactions:** Many operations support MongoDB transactions to ensure data consistency, especially for multi-step updates.
- **Optimistic Concurrency:** Updates to simulations use row versioning to prevent race conditions and ensure data integrity.
- **Error Handling:** All modules raise custom exceptions (`DatabaseError`, `ValidationError`) and log errors for observability.
- **Pagination & Indexing:** Supports efficient pagination and ensures indexes for fast queries and uniqueness.

---

## Extending

To add new data models or repositories:

1. Create a new `*_db.py` file for the entity.
2. Implement CRUD operations and ensure proper error handling and logging.
3. Add indexing and pagination as needed.
4. Integrate with the connection manager for consistent database access.

## Related Layers

- **Business Logic Layer:** See `app/business_logic/` for domain logic and workflows.
- **API Layer:** See `app/api/` for endpoint definitions and request handling. 